<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mökin sää</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
<style>
  body { background: #0e1116; color: #eaeef5; font-family: system-ui, sans-serif; margin: 0; }
  header { text-align: center; padding: 20px; }
  .cards { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
  .card { background: #171b22; padding: 10px 20px; border-radius: 10px; min-width: 180px; text-align: center; }
  .label { font-size: 12px; color: #a8b3c7; }
  .value { font-size: 28px; margin-top: 5px; }
  .updated { font-size: 12px; color: #a8b3c7; margin-top: 4px; }
  canvas { background: #171b22; border-radius: 10px; padding: 10px; }
</style>
</head>
<body>
<header>
  <h1>Mökin sää</h1>
  <p>ThingSpeak → GitHub Pages (public-kanava)</p>
</header>
<div class="cards">
  <div class="card">
    <div class="label">Lämpötila</div>
    <div class="value" id="tempVal">–</div>
    <div class="updated" id="tempTime">—</div>
  </div>
  <div class="card">
    <div class="label">Kosteus</div>
    <div class="value" id="humVal">–</div>
    <div class="updated" id="humTime">—</div>
  </div>
  <div class="card">
    <div class="label">Ilmanpaine</div>
    <div class="value" id="pressVal">–</div>
    <div class="updated" id="pressTime">—</div>
  </div>
</div>
<canvas id="tempChart"></canvas>
<canvas id="humChart"></canvas>
<canvas id="pressChart"></canvas>

<script>
const CHANNEL_ID = '3028480';
const FIELD_TEMP = 1, FIELD_HUM = 2, FIELD_PRESS = 3;

function apiUrl(days=7) {
  return `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?days=${days}&timezone=Europe/Helsinki&limit=8000`;
}
function fmtNum(v, d=1) { const n = parseFloat(v); return isFinite(n) ? n.toFixed(d).replace('.', ',') : '–'; }
function fmtTime(iso) { return iso ? new Date(iso).toLocaleString('fi-FI', { hour12:false }) : '—'; }

function updateCard(feeds, field, valEl, timeEl, unit) {
  const last = [...feeds].reverse().find(f => f[`field${field}`] !== null && f[`field${field}`] !== undefined && f[`field${field}`] !== '' && !Number.isNaN(Number(f[`field${field}`])));
  if (last) {
    valEl.textContent = `${fmtNum(last[`field${field}`])} ${unit}`;
    timeEl.textContent = `Päivitetty: ${fmtTime(last.created_at)}`;
  }
}
function makeDataset(feeds, field, label) {
  const labels = [];
  const data = [];
  for (const f of feeds) {
    const v = f[`field${field}`];
    if (v !== null && v !== undefined && v !== '' && !Number.isNaN(Number(v))) {
      labels.push(new Date(f.created_at));
      data.push(Number(v));
    }
  }
  return { labels, data, label };
}
function drawChart(ctx, dataset, unit) {
  new Chart(ctx, {
    type: 'line',
    data: { labels: dataset.labels, datasets: [{ label: dataset.label, data: dataset.data, borderWidth: 2, pointRadius: 0 }] },
    options: {
      responsive: true,
      scales: {
        x: {
          type: 'time',
          time: { tooltipFormat: 'dd.MM.yyyy HH:mm', displayFormats: { hour: 'dd.MM HH:mm', day: 'dd.MM.yyyy' } },
          ticks: { maxTicksLimit: 9 }
        },
        y: { beginAtZero: false }
      },
      plugins: { tooltip: { callbacks: { label: c => `${c.parsed.y} ${unit}` } } }
    }
  });
}

fetch(apiUrl(), { cache: 'no-store' })
  .then(r => r.json())
  .then(({feeds}) => {
    updateCard(feeds, FIELD_TEMP, document.getElementById('tempVal'), document.getElementById('tempTime'), '°C');
    updateCard(feeds, FIELD_HUM, document.getElementById('humVal'), document.getElementById('humTime'), '%');
    updateCard(feeds, FIELD_PRESS, document.getElementById('pressVal'), document.getElementById('pressTime'), 'hPa');
    drawChart(document.getElementById('tempChart'), makeDataset(feeds, FIELD_TEMP, 'Lämpötila'), '°C');
    drawChart(document.getElementById('humChart'), makeDataset(feeds, FIELD_HUM, 'Kosteus'), '%');
    drawChart(document.getElementById('pressChart'), makeDataset(feeds, FIELD_PRESS, 'Ilmanpaine'), 'hPa');
  })
  .catch(e => {
    console.error(e);
    alert('Datan haku epäonnistui. Tarkista CHANNEL_ID ja että kanava on public.');
  });
</script>
</body>
</html>
