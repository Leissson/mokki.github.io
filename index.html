<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mökin sää</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
<style>
  body { background: #0e1116; color: #eaeef5; font-family: system-ui, sans-serif; margin: 0; }
  header { text-align: center; padding: 20px; }
  .cards { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
  .card { background: #171b22; padding: 10px 20px; border-radius: 10px; min-width: 180px; text-align: center; }
  .label { font-size: 12px; color: #a8b3c7; }
  .value { font-size: 28px; margin-top: 5px; }
  .updated { font-size: 12px; color: #a8b3c7; margin-top: 4px; }
  .controls { text-align: center; margin-bottom: 15px; }
  select { background: #171b22; color: #eaeef5; border: 1px solid #2a3140; border-radius: 5px; padding: 5px 10px; margin: 0 5px; }
  .chart-section { margin-bottom: 20px; text-align: center; }
  canvas { background: #171b22; border-radius: 10px; padding: 10px; width: 100% !important; height: 300px !important; max-width: 600px; margin: auto; }
</style>
</head>
<body>
<header>
  <h1>Mökin sää</h1>
  <p>ThingSpeak → GitHub Pages (public-kanava)</p>
</header>
<div class="controls">
  <label for="rangeSel">Aikaväli:</label>
  <select id="rangeSel" onchange="loadAllData()">
    <option value="1">1 päivä</option>
    <option value="3">3 päivää</option>
    <option value="7" selected>7 päivää</option>
    <option value="30">30 päivää</option>
    <option value="90">90 päivää</option>
  </select>
</div>
<div class="cards">
  <div class="card">
    <div class="label">Lämpötila</div>
    <div class="value" id="tempVal">–</div>
    <div class="updated" id="tempTime">—</div>
  </div>
  <div class="card">
    <div class="label">Kosteus</div>
    <div class="value" id="humVal">–</div>
    <div class="updated" id="humTime">—</div>
  </div>
  <div class="card">
    <div class="label">Ilmanpaine</div>
    <div class="value" id="pressVal">–</div>
    <div class="updated" id="pressTime">—</div>
  </div>
</div>
<div class="chart-section"><canvas id="tempChart"></canvas></div>
<div class="chart-section"><canvas id="humChart"></canvas></div>
<div class="chart-section"><canvas id="pressChart"></canvas></div>
<script>
const CHANNEL_ID = '3028480';
const FIELD_TEMP = 1, FIELD_HUM = 2, FIELD_PRESS = 3;
let charts = {};

function apiUrl(days) {
  return `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?days=${days}&timezone=Europe/Helsinki&limit=8000`;
}
function fmtNum(v, d=1) { const n = parseFloat(v); return isFinite(n) ? n.toFixed(d).replace('.', ',') : '–'; }
function fmtTime(iso) { return iso ? new Date(iso).toLocaleString('fi-FI', { hour12:false }) : '—'; }
function updateCard(feeds, field, valEl, timeEl, unit) {
  const last = [...feeds].reverse().find(f => f[`field${field}`] !== null && f[`field${field}`] !== undefined && f[`field${field}`] !== '' && !Number.isNaN(Number(f[`field${field}`])));
  if (last) {
    valEl.textContent = `${fmtNum(last[`field${field}`])} ${unit}`;
    timeEl.textContent = `Päivitetty: ${fmtTime(last.created_at)}`;
  }
}
function makeDataset(feeds, field, label) {
  const labels = [], data = [];
  for (const f of feeds) {
    const v = f[`field${field}`];
    if (v !== null && v !== undefined && v !== '' && !Number.isNaN(Number(v))) {
      labels.push(new Date(f.created_at));
      data.push(Number(v));
    }
  }
  return { labels, data, label };
}
function drawChart(ctx, key, dataset, unit) {
  if (charts[key]) {
    charts[key].data.labels = dataset.labels;
    charts[key].data.datasets[0].data = dataset.data;
    charts[key].update();
    return;
  }
  charts[key] = new Chart(ctx, {
    type: 'line',
    data: { labels: dataset.labels, datasets: [{ label: dataset.label, data: dataset.data, borderWidth: 2, pointRadius: 0 }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          type: 'time',
          time: { tooltipFormat: 'dd.MM.yyyy HH:mm', displayFormats: { hour: 'dd.MM HH:mm', day: 'dd.MM.yyyy' } },
          ticks: { maxTicksLimit: 9 }
        },
        y: { beginAtZero: false }
      },
      plugins: { tooltip: { callbacks: { label: c => `${c.parsed.y} ${unit}` } } }
    }
  });
}

function loadAllData() {
  const days = parseInt(document.getElementById('rangeSel').value, 10);
  fetch(apiUrl(days), { cache: 'no-store' })
    .then(r => r.json())
    .then(({feeds}) => {
      updateCard(feeds, FIELD_TEMP, document.getElementById('tempVal'), document.getElementById('tempTime'), '°C');
      updateCard(feeds, FIELD_HUM, document.getElementById('humVal'), document.getElementById('humTime'), '%');
      updateCard(feeds, FIELD_PRESS, document.getElementById('pressVal'), document.getElementById('pressTime'), 'hPa');
      drawChart(document.getElementById('tempChart'), 'temp', makeDataset(feeds, FIELD_TEMP, 'Lämpötila'), '°C');
      drawChart(document.getElementById('humChart'), 'hum', makeDataset(feeds, FIELD_HUM, 'Kosteus'), '%');
      drawChart(document.getElementById('pressChart'), 'press', makeDataset(feeds, FIELD_PRESS, 'Ilmanpaine'), 'hPa');
    })
    .catch(e => {
      console.error(e);
      alert('Datan haku epäonnistui. Tarkista CHANNEL_ID ja että kanava on public.');
    });
}

window.addEventListener('load', loadAllData);
</script>
</body>
</html>
